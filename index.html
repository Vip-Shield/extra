<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  
  <title>Controle de Servi√ßo - PM</title>
  <meta name="theme-color" content="#020617">
  <link rel="manifest" href="manifest.json">
  <link rel="shortcut icon" type="image/png" href="icon-192.png">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Controle RAS/PROEIS">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    :root {
      --bg: #020617;
      --card: #0f172a;
      --primary: #fbbf24;
      --primary-hover: #f59e0b;
      --ok: #10b981;      
      --warn: #f59e0b;    
      --purple: #a855f7;  
      --danger: #ef4444;  
      --proeis: #3b82f6; 
      --ras: #fbbf24; 
      --day: #fbbf24;     
      --night: #38bdf8;   
      --text: #f8fafc;
      --muted: #94a3b8;
      --gold-shadow: rgba(251, 191, 36, 0.2);
    }

    * { box-sizing: border-box; font-family: 'Segoe UI', Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0;
      background: radial-gradient(circle at top, #1e293b 0%, #020617 100%);
      color: var(--text);
      padding: 15px 15px calc(40px + env(safe-area-inset-bottom)) 15px;
      min-height: 100vh;
      overscroll-behavior-y: none;
      position: relative;
    }

    /* --- REL√ìGIO DE FUNDO VINTAGE --- */
    .bg-clock {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90vw;
      max-width: 450px;
      opacity: 0.04; /* Discreto para n√£o atrapalhar leitura */
      z-index: -1; /* Fica no fundo */
      pointer-events: none;
      color: var(--primary);
      transition: opacity 0.3s, color 0.3s;
    }

    /* Eixo de rota√ß√£o dos ponteiros e anima√ß√£o realista */
    #hour-hand, #min-hand, #sec-hand {
      transform-origin: 50px 60px;
    }
    
    #sec-hand {
      transition: transform 0.1s cubic-bezier(0.4, 2.08, 0.55, 0.44); /* Efeito de 'tick' do ponteiro */
    }

    /* Anima√ß√£o do Rel√≥gio Tocando */
    @keyframes ringShake {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      10% { transform: translate(-50%, -50%) rotate(-6deg); }
      20% { transform: translate(-50%, -50%) rotate(6deg); }
      30% { transform: translate(-50%, -50%) rotate(-6deg); }
      40% { transform: translate(-50%, -50%) rotate(6deg); }
      50% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(0deg); }
    }

    .bg-clock.ringing {
      animation: ringShake 0.3s infinite;
      opacity: 0.15;
      color: var(--danger);
    }

    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto 20px auto;
      padding-top: env(safe-area-inset-top);
      gap: 15px;
    }

    .header-text { flex: 1; }

    /* Estiliza√ß√£o do bloco da Logo para doa√ß√£o */
    .logo-container {
      position: relative;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .logo-container:active { transform: scale(0.95); }

    .logo-app {
      width: 60px;
      height: 60px;
      border-radius: 16px;
      box-shadow: 0 8px 25px var(--gold-shadow);
      border: 2px solid rgba(251, 191, 36, 0.3);
      object-fit: cover;
    }

    .donate-badge {
      position: absolute;
      bottom: -6px;
      right: -6px;
      background: #ef4444;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.6);
      border: 1px solid rgba(255,255,255,0.2);
    }

    h1 { 
      margin: 0; 
      font-size: 1.6rem; 
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: linear-gradient(to bottom, #fff, #fbbf24);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      line-height: 1.2;
    }

    .limit-text { color: var(--muted); margin-top: 5px; font-size: 0.85rem; font-weight: 500;}

    .top-controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 25px;
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
    }

    .select-group {
      display: flex;
      gap: 8px;
      width: 100%;
    }

    select {
      width: 100%;
      padding: 12px 35px 12px 15px;
      border-radius: 12px;
      border: 1px solid rgba(251, 191, 36, 0.2);
      background-color: var(--card);
      color: white;
      font-size: 1rem;
      outline: none;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23fbbf24' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 16px;
    }

    select:focus { border-color: var(--primary); }

    .btn-icon {
      padding: 10px;
      border-radius: 12px;
      border: 1px solid rgba(251, 191, 36, 0.5);
      background-color: var(--card);
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 44px;
      transition: all 0.2s;
    }

    .btn-icon:active { transform: scale(0.92); background: #1e293b; }

    .btn-action {
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--ok);
      background: rgba(16, 185, 129, 0.15);
      color: var(--ok);
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-action:hover, .btn-action:active { background: var(--ok); color: #000; }

    .btn-whatsapp {
      width: 100%;
      padding: 12px;
      margin-top: 15px;
      border-radius: 12px;
      border: none;
      background: #25D366;
      color: #fff;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
      transition: all 0.2s;
    }
    .btn-whatsapp:active { transform: scale(0.98); background: #1da851; }

    .dashboard {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .card {
      background: var(--card);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid rgba(255,255,255,0.05);
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      position: relative;
    }

    .card h3 { 
      margin-top: 0; 
      color: var(--primary); 
      font-size: 1rem; 
      text-transform: uppercase; 
      letter-spacing: 1px;
      margin-bottom: 15px;
    }

    .summary-header {
      display: flex; 
      justify-content: space-between; 
      align-items: flex-end;
      flex-wrap: wrap; 
      gap: 10px;
    }

    .financial-summary {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      padding: 12px;
      border-radius: 10px;
      margin-top: 15px;
      text-align: center;
      font-size: 0.95rem;
    }

    .financial-summary strong {
      font-size: 1.4rem;
      color: var(--ok);
      display: block;
      margin-top: 5px;
    }

    .progress {
      background: #020617;
      border-radius: 20px;
      overflow: hidden;
      height: 14px; 
      margin: 15px 0;
      border: 1px solid rgba(255,255,255,0.05);
    }

    .progress-bar {
      height: 100%;
      transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .calendar {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(72px, 1fr));
      gap: 8px;
    }

    .day {
      background: #020617;
      border-radius: 12px;
      padding: 8px;
      min-height: 90px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      cursor: pointer;
      border: 1px solid rgba(255,255,255,0.03);
      position: relative;
      touch-action: manipulation;
    }

    .day:active { transform: scale(0.96); background: #1e293b; }

    .past-day { opacity: 0.4; filter: grayscale(80%); border-color: transparent; background: rgba(15, 23, 42, 0.5); }
    
    .today-highlight {
      border: 2px solid var(--primary) !important;
      box-shadow: 0 0 15px var(--gold-shadow);
      background: rgba(251, 191, 36, 0.1) !important;
      opacity: 1; filter: none;
    }

    .today-badge {
      position: absolute; top: -8px; right: -5px; background: var(--primary);
      color: #000; font-size: 9px; font-weight: 800; padding: 2px 6px;
      border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.5); z-index: 2;
    }

    .low { background: rgba(16, 185, 129, 0.08); border-left: 2px solid var(--ok); }
    .medium { background: rgba(251, 191, 36, 0.08); border-left: 2px solid var(--warn); }
    .twelve { background: rgba(168, 85, 247, 0.08); border-left: 2px solid var(--purple); }
    .high { background: rgba(239, 68, 68, 0.08); border-left: 2px solid var(--danger); }

    .badge {
      font-size: 9px; padding: 3px 4px; border-radius: 4px;
      font-weight: 700; text-transform: uppercase; text-align: center; margin-top: 2px;
    }

    .badge-proeis { background: var(--proeis); color: #fff; }
    .badge-ras { background: var(--ras); color: #000; }

    dialog {
      border: 1px solid var(--primary);
      border-radius: 20px;
      padding: 25px;
      background: #111827;
      color: var(--text);
      width: 90%;
      max-width: 340px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.9);
      margin: auto;
    }

    dialog::backdrop { background: rgba(0,0,0,0.8); backdrop-filter: blur(3px); }

    .close-btn {
      cursor: pointer; font-size: 1.8rem; padding: 5px 10px;
      margin: -10px -10px 0 0; line-height: 1; color: var(--muted);
    }

    dialog input, dialog select {
      width: 100%; padding: 14px; margin-top: 6px; margin-bottom: 12px;
      background: #020617; border: 1px solid #334155; border-radius: 10px;
      color: white; font-size: 1.1rem;
    }
    
    dialog input:focus, dialog select:focus { border-color: var(--primary); }

    dialog button {
      margin-top: 10px; padding: 16px; width: 100%; border: none;
      border-radius: 12px; background: var(--primary); color: #000;
      font-weight: 800; font-size: 1rem; box-shadow: 0 4px 14px rgba(251, 191, 36, 0.4);
      cursor: pointer;
    }
    
    dialog button:active { transform: scale(0.98); opacity: 0.9; }

    .hint-text { font-size: 12px; color: var(--muted); margin-top: -6px; margin-bottom: 12px; display: block; }
    
    .divider { height: 1px; background: rgba(255,255,255,0.1); margin: 15px 0; }

    @media (max-width: 900px) {
      .dashboard { grid-template-columns: 1fr; }
      .header-container { flex-direction: row; }
      .calendar { grid-template-columns: repeat(auto-fill, minmax(72px, 1fr)); }
      dialog { max-height: 90vh; overflow-y: auto; }
    }
  </style>
</head>
<body>

  <audio id="alarmSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

  <svg class="bg-clock" viewBox="0 0 100 120" xmlns="http://www.w3.org/2000/svg">
    <line x1="28" y1="85" x2="18" y2="105" stroke="currentColor" stroke-width="5" stroke-linecap="round"/>
    <line x1="72" y1="85" x2="82" y2="105" stroke="currentColor" stroke-width="5" stroke-linecap="round"/>
    
    <path d="M 45 25 C 20 15, 10 35, 20 45" stroke="currentColor" stroke-width="6" fill="none" stroke-linecap="round"/>
    <path d="M 55 25 C 80 15, 90 35, 80 45" stroke="currentColor" stroke-width="6" fill="none" stroke-linecap="round"/>
    
    <circle cx="50" cy="16" r="4" fill="currentColor" />
    <line x1="50" y1="20" x2="50" y2="30" stroke="currentColor" stroke-width="3"/>
    
    <circle cx="50" cy="60" r="32" fill="var(--bg)" stroke="currentColor" stroke-width="6"/>
    
    <line x1="50" y1="34" x2="50" y2="39" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
    <line x1="50" y1="81" x2="50" y2="86" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
    <line x1="24" y1="60" x2="29" y2="60" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
    <line x1="71" y1="60" x2="76" y2="60" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>

    <line id="hour-hand" x1="50" y1="60" x2="50" y2="45" stroke="currentColor" stroke-width="4" stroke-linecap="round"/>
    <line id="min-hand" x1="50" y1="60" x2="50" y2="36" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
    <line id="sec-hand" x1="50" y1="65" x2="50" y2="34" stroke="var(--danger)" stroke-width="2" stroke-linecap="round"/>
    
    <circle cx="50" cy="60" r="3" fill="var(--primary-hover)" />
  </svg>

  <header class="header-container">
    <div class="header-text">
      <h1>CONTROLE DE HORA EXTRA</h1>
      <p class="limit-text">Cota Mensal: <strong style="color:var(--text)">120h</strong></p>
    </div>
    <div class="logo-container" onclick="openDonateModal()" title="Apoiar o App">
      <img src="icon-512.png" alt="Logo" class="logo-app" onerror="this.src='https://placehold.co/90x90/orange/white?text=PM'">
      <div class="donate-badge">üíñ</div>
    </div>
  </header>

  <div class="top-controls">
    <div class="select-group">
      <select id="month"></select>
      <select id="year"></select>
      <button class="btn-icon" onclick="backupData()" title="Salvar Backup">üíæ</button>
      <button class="btn-icon" onclick="openConfigModal()" title="Configura√ß√µes">‚öôÔ∏è</button>
    </div>
    <button class="btn-action" onclick="checkAlarms()">üîî Checar Servi√ßos (Hoje/Amanh√£)</button>
  </div>

  <div class="dashboard">
    <div class="card">
      <h3>Resumo do M√™s</h3>
      <div class="summary-header">
        <div>Total: <strong id="total" style="font-size: 1.4rem; color: #fff;">0</strong> h</div>
        <div style="font-size: 0.9rem; color: var(--muted);">Restante: <strong id="remaining">120</strong> h</div>
      </div>
      
      <div class="progress"><div id="bar" class="progress-bar"></div></div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9rem; margin-top: 15px;">
        <div style="background: rgba(255,255,255,0.03); padding: 10px; border-radius: 10px; text-align: center;">
          <span style="display:block; font-size: 0.8em; color: var(--muted); margin-bottom: 2px;">PROEIS</span>
          <strong id="proeisTotal" style="color: var(--proeis); font-size: 1.3em">0</strong> h
        </div>
        <div style="background: rgba(255,255,255,0.03); padding: 10px; border-radius: 10px; text-align: center;">
          <span style="display:block; font-size: 0.8em; color: var(--muted); margin-bottom: 2px;">RAS</span>
          <strong id="rasTotal" style="color: var(--ras); font-size: 1.3em">0</strong> h
        </div>
      </div>

      <div class="financial-summary">
        Estimativa a Receber
        <strong id="moneyTotal">R$ 0,00</strong>
        <span style="font-size: 11px; color: var(--muted); display: block; margin-top: 4px;">(Inclui Ajuda de Custo/Passagem)</span>
      </div>

      <button class="btn-whatsapp" onclick="exportToWhatsApp()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51a12.8 12.8 0 0 0-.57-.01c-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 0 1-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 0 1-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 0 1 2.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0 0 12.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 0 0 5.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 0 0-3.48-8.413Z"/>
        </svg>
        Exportar para o WhatsApp
      </button>

    </div>

    <div class="card">
      <h3 style="display:flex; justify-content:space-between; align-items:center">
        LAN√áAMENTOS <span style="font-size:0.7em; color:var(--muted); opacity:0.6; font-weight:normal">Toque no dia</span>
      </h3>
      <div class="calendar" id="calendar"></div>
    </div>
  </div>

  <dialog id="donateModal">
    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
      <h3 style="margin:0; font-size: 1.2rem; color: var(--primary);">Apoie o Projeto üëÆ‚Äç‚ôÇÔ∏è</h3>
      <span class="close-btn" onclick="donateModal.close()">&times;</span>
    </div>
    <p style="font-size: 0.95rem; color: var(--muted); line-height: 1.5; margin-bottom: 20px;">
      Este app foi feito para facilitar sua rotina. Se ele tem sido √∫til, considere fazer uma doa√ß√£o simb√≥lica de <strong>R$ 1,00</strong> pelo PIX para apoiar o desenvolvedor e manter as atualiza√ß√µes!
    </p>
    
    <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; text-align: center; border: 1px dashed var(--primary); margin-bottom: 15px;">
      <p style="margin: 0 0 5px 0; font-size: 0.85rem; color: var(--text);">Chave PIX:</p>
      <strong id="pixKey" style="font-size: 1.1rem; color: var(--primary); word-break: break-all;">21982539175</strong>
    </div>

    <button onclick="copyPix()" style="background: #25D366; color: #fff; border-radius: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.95rem; padding: 14px;">
      <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
      Copiar Chave PIX
    </button>
  </dialog>

  <dialog id="modal">
    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
      <div>
        <h3 style="margin:0; font-size: 1.2rem">Lan√ßar Servi√ßo</h3>
        <p id="modalDay" style="color: var(--primary); margin: 2px 0 0 0; font-weight: bold; font-size: 0.9rem"></p>
      </div>
      <span class="close-btn" onclick="modal.close()">&times;</span>
    </div>
    
    <label style="font-size: 13px; color: var(--muted); display:block; margin-bottom:2px">Horas (Cota)</label>
    <input type="number" id="hoursInput" min="0" max="24" placeholder="Ex: 12" inputmode="decimal" step="0.5" />
    
    <label style="font-size: 13px; color: var(--muted); display:block; margin-bottom:2px">Tipo de Servi√ßo</label>
    <select id="typeInput">
      <option value="proeis">üëÆ PROEIS</option>
      <option value="ras">üöì RAS</option>
    </select>

    <label style="font-size: 13px; color: var(--muted); display:block; margin-bottom:2px">Turno</label>
    <select id="shiftInput">
      <option value="day">‚òÄÔ∏è Diurno</option>
      <option value="night">üåô Noturno</option>
    </select>
    
    <button onclick="saveHours()">SALVAR</button>
  </dialog>

  <dialog id="configModal">
    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
      <h3 style="margin:0; font-size: 1.2rem; color: var(--primary);">Configura√ß√µes</h3>
      <span class="close-btn" onclick="configModal.close()">&times;</span>
    </div>
    
    <label style="font-size: 13px; color: var(--muted); display:block; margin-bottom:2px">Sua Gradua√ß√£o</label>
    <select id="rankInput">
      <option value="SD">Soldado (SD)</option>
      <option value="CB_SGT">Cabo / Sargento (CB/SGT)</option>
    </select>
    <span class="hint-text">Define o valor base de R$ 333 ou R$ 444.</span>

    <label style="font-size: 13px; color: var(--muted); display:block; margin-bottom:2px">Cota Mensal M√°xima (Horas)</label>
    <input type="number" id="maxHoursInput" min="0" placeholder="Ex: 120" />
    
    <div class="divider"></div>

    <h4 style="margin: 0 0 10px 0; font-size: 1rem; color: var(--primary);">Ajuda de Custo (R$)</h4>

    <label style="font-size: 13px; color: var(--muted); display:block; margin-bottom:2px">PROEIS (Passagem/Alimenta√ß√£o)</label>
    <input type="number" id="proeisAllowanceInput" min="0" step="0.01" placeholder="Ex: 35.00" />

    <label style="font-size: 13px; color: var(--muted); display:block; margin-bottom:2px">RAS (Passagem)</label>
    <input type="number" id="rasAllowanceInput" min="0" step="0.01" placeholder="Ex: 13.00" />
    
    <button onclick="saveConfig()" style="background: var(--ok); color: #000;">SALVAR CONFIGURA√á√ïES</button>
  </dialog>

  <script>
    const calendar = document.getElementById('calendar');
    const modal = document.getElementById('modal');
    const configModal = document.getElementById('configModal');
    const donateModal = document.getElementById('donateModal');
    const modalDay = document.getElementById('modalDay');
    const hoursInput = document.getElementById('hoursInput');
    const typeInput = document.getElementById('typeInput');
    const shiftInput = document.getElementById('shiftInput');
    const totalEl = document.getElementById('total');
    const proeisTotalEl = document.getElementById('proeisTotal');
    const rasTotalEl = document.getElementById('rasTotal');
    const moneyTotalEl = document.getElementById('moneyTotal');
    const remainingEl = document.getElementById('remaining');
    const bar = document.getElementById('bar');
    const monthSelect = document.getElementById('month');
    const yearSelect = document.getElementById('year');
    const alarmSound = document.getElementById('alarmSound');
    const bgClock = document.querySelector('.bg-clock');

    let selectedDay;
    let data = JSON.parse(localStorage.getItem('pmServiceData')) || {};
    
    let config = JSON.parse(localStorage.getItem('pmConfig')) || { 
      rank: 'CB_SGT', 
      maxHours: 120,
      proeisAllowance: 35.00,
      rasAllowance: 13.00
    };

    [modal, configModal, donateModal].forEach(m => {
      m.addEventListener('click', (event) => { if (event.target === m) m.close(); });
    });

    // --- L√ìGICA DOS PONTEIROS DO REL√ìGIO DE FUNDO ---
    function updateClockHands() {
      const now = new Date();
      const sec = now.getSeconds();
      const min = now.getMinutes();
      const hour = now.getHours();

      const secDeg = sec * 6;
      const minDeg = min * 6 + (sec * 0.1);
      const hourDeg = (hour % 12) * 30 + (min * 0.5);

      document.getElementById('sec-hand').style.transform = `rotate(${secDeg}deg)`;
      document.getElementById('min-hand').style.transform = `rotate(${minDeg}deg)`;
      document.getElementById('hour-hand').style.transform = `rotate(${hourDeg}deg)`;
    }
    setInterval(updateClockHands, 1000);
    updateClockHands();

    function initDateSelectors() {
      const now = new Date();
      const capitalize = (s) => s.charAt(0).toUpperCase() + s.slice(1);
      
      for (let m = 0; m < 12; m++) {
        const monthName = new Date(0, m).toLocaleString('pt-BR', { month: 'long' });
        monthSelect.innerHTML += `<option value="${m}">${capitalize(monthName)}</option>`;
      }
      for (let y = now.getFullYear() - 1; y <= now.getFullYear() + 2; y++) {
        yearSelect.innerHTML += `<option value="${y}">${y}</option>`;
      }
      monthSelect.value = now.getMonth();
      yearSelect.value = now.getFullYear();
    }

    function key() { return `${yearSelect.value}-${monthSelect.value}`; }
    function daysInMonth() { return new Date(yearSelect.value, Number(monthSelect.value) + 1, 0).getDate(); }

    function renderCalendar() {
      calendar.innerHTML = '';
      const k = key();
      if (!data[k]) data[k] = {};

      const todayDate = new Date();
      const currentYear = todayDate.getFullYear();
      const currentMonth = todayDate.getMonth();
      const currentDay = todayDate.getDate();

      for (let i = 1; i <= daysInMonth(); i++) {
        const entry = data[k][i] || { h: 0, t: 'proeis', s: 'day' };
        const d = document.createElement('div');
        d.className = 'day';

        const selYear = Number(yearSelect.value);
        const selMonth = Number(monthSelect.value);
        
        const isPastDay = (selYear < currentYear) || 
                          (selYear === currentYear && selMonth < currentMonth) || 
                          (selYear === currentYear && selMonth === currentMonth && i < currentDay);
                          
        const isToday = (selYear === currentYear && selMonth === currentMonth && i === currentDay);

        if (isPastDay && !isToday) d.classList.add('past-day');
        if (isToday) d.classList.add('today-highlight');

        if (entry.h > 0 && entry.h <= 6) d.classList.add('low');
        else if (entry.h > 6 && entry.h <= 8) d.classList.add('medium');
        else if (entry.h === 12) d.classList.add('twelve');
        else if (entry.h > 12) d.classList.add('high');

        const shiftColor = entry.h > 0 ? (entry.s === 'night' ? 'var(--night)' : 'var(--day)') : 'rgba(255,255,255,0.1)';
        const shiftIcon = entry.h > 0 ? (entry.s === 'night' ? 'üåô' : '‚òÄÔ∏è') : '';

        d.innerHTML = `
          ${isToday ? '<div class="today-badge">HOJE</div>' : ''}
          <div style="display:flex; justify-content:space-between; width:100%">
            <small style="color:var(--muted); font-size:0.75em">Dia</small>
            <strong style="font-size: 1em; color:var(--text)">${i}</strong>
          </div>
          <div style="font-weight: 800; font-size: 1.4em; text-align:center; color: ${shiftColor}">
            ${entry.h > 0 ? entry.h + '<span style="font-size:0.6em; margin-left:3px">' + shiftIcon + '</span>' : '-'}
          </div>
          ${entry.h ? `<span class="badge ${entry.t === 'proeis' ? 'badge-proeis' : 'badge-ras'}">${entry.t.toUpperCase()}</span>` : '<div style="height:15px"></div>'}
        `;

        d.onclick = () => openModal(i);
        calendar.appendChild(d);
      }
      updateSummary();
    }

    function checkAlarms() {
      const today = new Date();
      const tYear = today.getFullYear();
      const tMonth = today.getMonth();
      const tDay = today.getDate();
      const todayKey = `${tYear}-${tMonth}`;
      
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);
      const tomYear = tomorrow.getFullYear();
      const tomMonth = tomorrow.getMonth();
      const tomDay = tomorrow.getDate();
      const tomorrowKey = `${tomYear}-${tomMonth}`;

      let msg = "";
      let hasService = false;

      if (data[todayKey] && data[todayKey][tDay] && data[todayKey][tDay].h > 0) {
        const horas = data[todayKey][tDay].h;
        const periodo = data[todayKey][tDay].t.toUpperCase();
        const turno = data[todayKey][tDay].s === 'night' ? 'Noturno' : 'Diurno';
        msg += `üö® HOJE: Escala de ${horas}h de ${periodo} (${turno}).\n`;
        hasService = true;
      } else {
        msg += `‚úÖ HOJE: Sem servi√ßo (Folga).\n`;
      }

      if (data[tomorrowKey] && data[tomorrowKey][tomDay] && data[tomorrowKey][tomDay].h > 0) {
        const horas = data[tomorrowKey][tomDay].h;
        const periodo = data[tomorrowKey][tomDay].t.toUpperCase();
        const turno = data[tomorrowKey][tomDay].s === 'night' ? 'Noturno' : 'Diurno';
        msg += `\nüö® AMANH√É: Prepare fardamento! Escala de ${horas}h de ${periodo} (${turno}).\n`;
        hasService = true;
      } else {
        msg += `\n‚úÖ AMANH√É: Sem servi√ßo (Folga).\n`;
      }

      if (hasService) {
        // Toca som e faz o rel√≥gio do fundo tremer
        alarmSound.play().catch(e => console.log("√Åudio bloqueado."));
        bgClock.classList.add('ringing');
        setTimeout(() => bgClock.classList.remove('ringing'), 4000); // Para ap√≥s 4 segundos
      }

      alert(`‚è∞ ALERTA DE SERVI√áOS ‚è∞\n\n${msg}\nBom descanso e bom servi√ßo, combatente!`);
    }

    function openDonateModal() {
      donateModal.showModal();
    }

    function copyPix() {
      const pixKey = document.getElementById('pixKey').innerText;
      navigator.clipboard.writeText(pixKey).then(() => {
        alert("Chave PIX copiada com sucesso!\nObrigado pela moral, combatente! üöì");
      }).catch(err => {
        alert("Erro ao copiar a chave. Tente selecionar e copiar manualmente.");
      });
    }

    function backupData() {
      const exportData = {
        escala: JSON.parse(localStorage.getItem('pmServiceData')) || {},
        config: JSON.parse(localStorage.getItem('pmConfig')) || {}
      };
      
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportData, null, 2));
      
      const downloadAnchorNode = document.createElement('a');
      downloadAnchorNode.setAttribute("href", dataStr);
      downloadAnchorNode.setAttribute("download", "backup_escala_pm.json");
      document.body.appendChild(downloadAnchorNode);
      downloadAnchorNode.click();
      downloadAnchorNode.remove();
      
      alert("‚úÖ Backup salvo!\nO arquivo 'backup_escala_pm.json' foi baixado no seu dispositivo.");
    }

    function openConfigModal() {
      document.getElementById('rankInput').value = config.rank || 'CB_SGT';
      document.getElementById('maxHoursInput').value = config.maxHours || 120;
      document.getElementById('proeisAllowanceInput').value = config.proeisAllowance !== undefined ? config.proeisAllowance : 35.00;
      document.getElementById('rasAllowanceInput').value = config.rasAllowance !== undefined ? config.rasAllowance : 13.00;
      configModal.showModal();
    }

    function saveConfig() {
      config.rank = document.getElementById('rankInput').value;
      config.maxHours = parseInt(document.getElementById('maxHoursInput').value) || 120;
      config.proeisAllowance = parseFloat(document.getElementById('proeisAllowanceInput').value) || 0;
      config.rasAllowance = parseFloat(document.getElementById('rasAllowanceInput').value) || 0;
      
      localStorage.setItem('pmConfig', JSON.stringify(config));
      configModal.close();
      
      document.querySelector('.limit-text strong').textContent = config.maxHours + 'h';
      updateSummary();
    }

    function exportToWhatsApp() {
      const monthName = monthSelect.options[monthSelect.selectedIndex].text;
      const yearName = yearSelect.value;
      const totalH = totalEl.textContent;
      const proeisH = proeisTotalEl.textContent;
      const rasH = rasTotalEl.textContent;
      const moneyText = moneyTotalEl.textContent;
      const rankText = config.rank === 'SD' ? 'Soldado (SD)' : 'Cabo/Sargento';
      
      let msg = `*Controle de Servi√ßo Extra* üöì\n`;
      msg += `M√™s: ${monthName}/${yearName}\n`;
      msg += `Gradua√ß√£o base: ${rankText}\n`;
      msg += `-------------------------\n`;
      msg += `Total de Horas: *${totalH}h*\n`;
      msg += `üîµ PROEIS: ${proeisH}h\n`;
      msg += `üü° RAS: ${rasH}h\n`;
      msg += `üí∞ *Estimativa a Receber: ${moneyText}*\n`;
      msg += `-------------------------\n`;
      msg += `*Escala do M√™s:*\n`;
      
      const k = key();
      let hasEntries = false;
      
      if (data[k]) {
        for (let i = 1; i <= daysInMonth(); i++) {
          if (data[k][i] && data[k][i].h > 0) {
            const h = data[k][i].h;
            const t = data[k][i].t.toUpperCase();
            const s = data[k][i].s === 'night' ? 'üåô Noturno' : '‚òÄÔ∏è Diurno';
            const dayStr = i.toString().padStart(2, '0');
            msg += `- Dia ${dayStr}: ${h}h | ${t} | ${s}\n`;
            hasEntries = true;
          }
        }
      }
      
      if (!hasEntries) {
        msg += `_Nenhum servi√ßo registrado neste m√™s._\n`;
      }
      
      const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(msg)}`;
      window.open(whatsappUrl, '_blank');
    }

    function openModal(day) {
      selectedDay = day;
      const entry = data[key()][day] || { h: 0, t: 'proeis', s: 'day' };
      modalDay.textContent = `${day} de ${monthSelect.options[monthSelect.selectedIndex].text}`;
      hoursInput.value = entry.h === 0 ? '' : entry.h;
      typeInput.value = entry.t;
      shiftInput.value = entry.s || 'day';
      modal.showModal();
      setTimeout(() => hoursInput.focus(), 50);
    }

    function saveHours() {
      let val = hoursInput.value === '' ? 0 : parseFloat(hoursInput.value);
      if(val < 0) val = 0;
      
      data[key()][selectedDay] = { h: val, t: typeInput.value, s: shiftInput.value };
      localStorage.setItem('pmServiceData', JSON.stringify(data));
      modal.close();
      renderCalendar();
    }

    function updateSummary() {
      const entries = Object.values(data[key()] || {});
      let total = 0, proeisT = 0, rasT = 0, moneyTotal = 0;
      
      const baseHourlyRate = config.rank === 'SD' ? (333 / 12) : (444 / 12);
      const proeisAllow = config.proeisAllowance !== undefined ? config.proeisAllowance : 35.00;
      const rasAllow = config.rasAllowance !== undefined ? config.rasAllowance : 13.00;
      
      entries.forEach(e => {
        const h = parseFloat(e.h);
        if (h > 0) {
            total += h;
            const allowance = e.t === 'proeis' ? proeisAllow : rasAllow;
            moneyTotal += (h * baseHourlyRate) + allowance;
            e.t === 'proeis' ? proeisT += h : rasT += h;
        }
      });
      
      const fmt = (n) => Number.isInteger(n) ? n : n.toFixed(1);
      const maxH = config.maxHours || 120;

      totalEl.textContent = fmt(total);
      proeisTotalEl.textContent = fmt(proeisT);
      rasTotalEl.textContent = fmt(rasT);
      remainingEl.textContent = fmt(Math.max(0, maxH - total));
      
      moneyTotalEl.textContent = moneyTotal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
      
      const pct = Math.min(100, (total / maxH) * 100);
      bar.style.width = pct + '%';
      bar.style.background = pct < 70 ? 'var(--ok)' : pct < 100 ? 'var(--warn)' : 'var(--danger)';
      bar.style.boxShadow = `0 0 15px ${pct < 70 ? 'rgba(16, 185, 129, 0.4)' : 'rgba(245, 158, 11, 0.4)'}`;
    }

    document.querySelector('.limit-text strong').textContent = (config.maxHours || 120) + 'h';
    
    monthSelect.onchange = yearSelect.onchange = renderCalendar;
    initDateSelectors();
    renderCalendar();

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('SW registrado!'))
          .catch(err => console.log('Erro no SW:', err));
      });
    }
  </script>

</body>

</html>
